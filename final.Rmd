---
title: "Analysis of Car Accidents in Barcelona"
author: "Ivan Iliash, Johann Promeuschel, Manuel Coutinho, Onat Kaya"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Data Analysis and Visualization in R (IN2339) - Case Study
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r libraries, include=FALSE}
library(ggplot2)
library(data.table)
library(dplyr)
library(tidyr)
library(ggrepel)
library(ppcor)
library(patchwork)
library(forcats)
library(ggpubr)
```

```{r dts}
DATA_FOLDER <- 'data'

load_dt <- function(folder, file){
  dt <- fread(file.path(folder, file)) # Read document
  setnames(dt, colnames(dt), gsub(' ', '.', colnames(dt))) # Replaces spaces with . in column names
  return(dt)
}

acc_dt <- load_dt(DATA_FOLDER, 'accidents_2017.csv')
pop_dt <- load_dt(DATA_FOLDER, 'population.csv')
transport_dt <- load_dt(DATA_FOLDER, 'transports.csv')
bus_dt <- load_dt(DATA_FOLDER, "bus_stops.csv")
```

```{r}

# IGNORE (my (johann) data preparation)


accidents_neighborhood <-acc_dt[, .(accidents = .N), Neighborhood.Name]
accidents_neighborhood <- accidents_neighborhood[order(tolower(accidents_neighborhood$Neighborhood.Name)),]
accidents_neighborhood <- accidents_neighborhood[!(accidents_neighborhood$Neighborhood.Name == "Unknown")]

# bus stops
stops_neighborhood <- bus_dt[, .(bus_stops = .N), Neighborhood.Name]
stops_neighborhood$Neighborhood.Name[stops_neighborhood$Neighborhood.Name == ""] <- "unknown"
stops_neighborhood <- stops_neighborhood[!(stops_neighborhood$Neighborhood.Name == "unknown")]
stops_neighborhood <- stops_neighborhood[order(tolower(stops_neighborhood$Neighborhood.Name)),]

# transport
transport_neighborhood <- transport_dt[, .(transports = .N), Neighborhood.Name]
transport_neighborhood$Neighborhood.Name[transport_neighborhood$Neighborhood.Name == ""] <- "unknown"
transport_neighborhood <- transport_neighborhood[!(transport_neighborhood$Neighborhood.Name == "unknown")]
missing <- setdiff(stops_neighborhood$Neighborhood.Name, transport_neighborhood$Neighborhood.Name)
tmp <- data.table(Neighborhood.Name = missing, transports = rep(0, 10))
transport_neighborhood <- rbind(transport_neighborhood, tmp)
transport_neighborhood <- transport_neighborhood[order(tolower(transport_neighborhood$Neighborhood.Name)),]

# population
pop_neighborhood <- pop_dt[Year == "2017", .(population = sum(Number)), by=Neighborhood.Name]
pop_neighborhood$Neighborhood.Name[pop_neighborhood$Neighborhood.Name == ""] <- "unknown"
pop_neighborhood <- pop_neighborhood[!(pop_neighborhood$Neighborhood.Name == "unknown")]
missing <- setdiff(stops_neighborhood$Neighborhood.Name, pop_neighborhood)
tmp <- data.table(Neighborhood.Name = missing, population = NA)
pop_neighborhood <- rbind(pop_neighborhood, tmp)
pop_neighborhood <- pop_neighborhood[order(tolower(transport_neighborhood$Neighborhood.Name)), ]

df <- accidents_neighborhood %>% .[, `:=` (bus_stops=stops_neighborhood$bus_stops, 
                                           transports=transport_neighborhood$transports,
                                           population=pop_neighborhood$population)]
df <- data.table(df)
``` 


# Motivation and Goals

In 2017, with a population of about 1.621 million, the capital of Catalonia had an accident rate way above the national average (582 vs 219^[From Dirección General de Tráfico, Accessed 16 January 2022 <https://revista.dgt.es/es/noticias/nacional/2018/07JULIO/0712-Siniestralidad-2017.shtml>] accidents with victims per 100.000 inhabitants).
In an attempt of mitigating the high number of accidents that occurred in the city of Barcelona, we try to understand which factors can explain them and how can we predict XXXX (TODO: insert prediction task and specify work done).



```{r goals, include=FALSE}
# National Accident with victims rate:
total_accidents_with_victims <- 102233 #from source [1]
total_population <- 46658447 # from Wikipedia
total_acc_rate_per100 <- total_accidents_with_victims / total_population * 1e5

# Barcelona Accidents with victims rate:
barc_accidents_with_victims <- nrow(acc_dt[Victims > 0])
barc_population <- sum(pop_dt[Year == 2017, Number])
barc_acc_rate_per100 <- barc_accidents_with_victims / barc_population * 1e5

sprintf("Total number of accidents with victims per 100k: %d", round(total_acc_rate_per100))
sprintf("Barcelona number of accidents with victims per 100k: %d", round(barc_acc_rate_per100))
```

# Data Preparation
During the usual data preparation needed to plot the data, we noticed that some district and neighborhood were marked as "Unkown", so we filled out these gaps in the 'accidents_2017.csv' dataset by adding the correct values. This was done with a Python script using the Longitude and Latitude coordinates of the accident and requesting the information from the OpenStreetMap API^[<https://wiki.openstreetmap.org/wiki/API>].

```{r, include=FALSE}
# Proof of dataset cleaning
sprintf("Number of Unkown Districts before cleaning vs after: %d - %d", 
        nrow(load_dt(DATA_FOLDER, 'accidents_2017.csv')[District.Name == 'Unknown']), 
        nrow(acc_dt[District.Name == 'Unknown']))

# 2017 Population x Accident Aggregated by District or Neighborhood
pop2017_dt <- pop_dt[Year == 2017]

# TODO: passing column names as argument is not working
# prepare_pop_x_acc <- function(pop_dt, acc_dt, aggr.variable){
#   pop_by_var_dt <- aggregate(list(Number=pop_dt$Number), by=list(aggr.variable=pop_dt$aggr.variable), FUN=sum)
#   acc_by_var_dt <- acc_dt[, .N, by=aggr.variable]
#   return(merge(pop_by_var_dt, acc_by_var_dt, by=aggr.variable))
# }

# pop_x_acc_by_neighboorhood_dt <- prepare_pop_x_acc(pop2017_dt, acc_dt=acc_dt, aggr.variable = 'Neighborhood.Name')
# pop_x_acc_by_district_dt <- prepare_pop_x_acc(aggr.variable = 'District.Name')


pop_by_district_dt <- aggregate(list(Number=pop2017_dt$Number), by=list(District.Name=pop2017_dt$District.Name), FUN=sum)
pop_by_neighborhood_dt <- aggregate(list(Number=pop2017_dt$Number), by=list(Neighborhood.Name=pop2017_dt$Neighborhood.Name), FUN=sum)

# Accidents by Neighborhood and by District
acc_by_neighboorhood_dt <- acc_dt[, .N, by=Neighborhood.Name]
setnames(acc_by_neighboorhood_dt, "N", "N.Accidents")
acc_by_district_dt <- acc_dt[, .N, by=District.Name]
setnames(acc_by_district_dt, "N", "N.Accidents")

# Accidents by Population Datasets
pop_x_acc_by_neighboorhood_dt <- merge(pop_by_neighborhood_dt, acc_by_neighboorhood_dt, by='Neighborhood.Name')
pop_x_acc_by_district_dt <- merge(pop_by_district_dt, acc_by_district_dt, by='District.Name')

# Transports by Neighborhood and by District
transport_by_neighboorhood_dt <- transport_dt[, .N, by=Neighborhood.Name]
setnames(transport_by_neighboorhood_dt, "N", "N.Transports")
transport_by_district_dt <- transport_dt[, .N, by=District.Name]
setnames(transport_by_district_dt, "N", "N.Transports")

# Accidents by Transports Datasets
trans_x_acc_by_neighborhood_dt <- merge(transport_by_neighboorhood_dt, acc_by_neighboorhood_dt, by="Neighborhood.Name", all.y = T)
trans_x_acc_by_neighborhood_dt[, N.Transports := replace_na(N.Transports, 0)]

trans_x_acc_by_district_dt <- merge(transport_by_district_dt, acc_by_district_dt, by="District.Name", all.y = T)
trans_x_acc_by_district_dt[, N.Transports := replace_na(N.Transports, 0)]
```


# Data Analysis
Since Barcelona is the second most populated city in Spain^[From Wikipedia, Accessed 17 January 2022 <https://en.wikipedia.org/wiki/List_of_European_cities_by_population_within_city_limits>], what first comes to mind is that the  number of accidents is related to the number of people living in a district or neighborhood, as that inevitably leads to more traffic.
We start by simply showing the number of accidents by district:

```{r acc_distr}
# TODO: don't know if geom_text is needed, simplify graphic? - clean lines, background, ...
acc_dt %>% ggplot(aes(x=fct_infreq(District.Name))) + 
  geom_bar() +
  geom_text(stat='count', aes(label=..count..), vjust=-0.3) +
  labs(x = 'District', y = 'Number of Accidents') +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.95, hjust=0.9))

```
One can immediately notice a clear outlier being the Eixample district, which is in fact the most populated, and most visited district in Barcelona, which could explain the exceptionally high number of accidents.
We proceed by testing the proposed correlation between population and the number of accidents, comparing different Neighborhoods and Districts:

```{r corr_pop_x_acc, warning=FALSE, fig.width=13, message = FALSE}
# TODO: adjust, make x axis label centered, same size -> aesthetics

p1 <- pop_x_acc_by_neighboorhood_dt %>% 
  ggplot(aes(x=Number,y=N.Accidents)) + geom_point() + stat_smooth(method="lm") + 
  geom_text_repel(aes(label=Neighborhood.Name)) +
  labs(x = '', y = 'Number of Accidents', title = "Number of Accidents by Neighborhood Population") +
  theme(plot.title = element_text(size=14, margin=margin(b=14)))
p2 <- pop_x_acc_by_district_dt %>% 
  ggplot(aes(x=Number,y=N.Accidents)) + geom_point() + stat_smooth(method="lm") + 
  geom_text_repel(aes(label=District.Name)) +
  labs(x='', y='', title = "Number of Accidents by District Population") +
  theme(plot.title = element_text(size=14, margin=margin(b=14)))

p1 + p2
grid::grid.draw(grid::textGrob("Population", y=0.05, x=0.52))

```

Although both these correlations are statistically significant (p-value lower than .05 in both cases of the Spearman's rank correlation test), we can again notice Eixample and some of its neighborhoods (like "la Dreta de l'Eixample" and "l'Antiga Esquerra de l'Eixample") as clear outliers. This can be explained with the touristic focus that lies on this district, which further heightens the traffic. 

```{r corr_pop_x_acc_tests, include=FALSE}
# TODO: is "include=FALSE" really what we want?

print("Population in neighboorhood vs N Accident")
cor.test(pop_x_acc_by_neighboorhood_dt$Number, pop_x_acc_by_neighboorhood_dt$N.Accidents, method="spearman", exact=FALSE)

print("Population in district vs N Accident")
cor.test(pop_x_acc_by_district_dt$Number, pop_x_acc_by_district_dt$N.Accidents, method="spearman")
```

As we don't have any direct metric for the traffic, we attempt use the number of transportation stations in a certain area as a proxy for its afflux of people.

```{r corr_trans_x_acc, warning=FALSE, fig.width=13, message = FALSE}
# TODO: adjust, make x axis label centered, same size -> aesthetics -> same as before

p1 <- trans_x_acc_by_neighborhood_dt %>% 
  ggplot(aes(x=N.Transports,y=N.Accidents)) + geom_point() + stat_smooth(method="lm") + 
  geom_text_repel(aes(label=Neighborhood.Name)) +
  labs(x = '', y = 'Number of Accidents', title = "Number of Accidents by Number of Transports in the Neighborhood") +
  theme(plot.title = element_text(size=14, margin=margin(b=14)))

p2 <- trans_x_acc_by_district_dt %>% 
  ggplot(aes(x=N.Transports,y=N.Accidents)) + geom_point() + stat_smooth(method="lm") + 
  geom_text_repel(aes(label=District.Name)) +
  labs(x='', y='', title = "Number of Accidents by Number of Transports in the District") +
  theme(plot.title = element_text(size=14, margin=margin(b=14)))

p1 + p2
grid::grid.draw(grid::textGrob("Number of Transports", y=0.05, x=0.52))

```
It would be naïve of to assume it would all be explained by only this one variable. The number of stations could very well be connected to the physical area of the district/neighborhood, which obviously means a higher probability of accidents (maybe normalize by area size?).
However the correlations seem to be stronger than the population correlation the we showed above (rho values: TODO: see if this is true), so it still seems like a good indicator.
```{r corr_trans_x_acc_tests, include=FALSE}
# TODO: is "include=FALSE" really what we want?

print("Number of Transports in neighboorhood vs N Accident")
cor.test(trans_x_acc_by_neighborhood_dt$N.Transports, trans_x_acc_by_neighborhood_dt$N.Accidents, method="spearman", exact=FALSE)

print("Number of Transports in district vs N Accident")
cor.test(trans_x_acc_by_district_dt$N.Transports, trans_x_acc_by_district_dt$N.Accidents, method="spearman")
```

### Bus stops as confounding variable?

One could argue that the number of buses in an area is the real influence here.  

```{r echo=FALSE, results="hide", fig.keep="all", message=FALSE, running=FALSE, warning = FALSE}

df_melt <- melt(df, id.vars = c("Neighborhood.Name", "accidents"), variable.name = "group", 
                value.name = "value")


p1 <- ggplot(df) + geom_point(aes(bus_stops, accidents, color = "bus_stops")) + 
  geom_point(aes(transports, accidents, color = "transports")) + 
  geom_smooth(mapping=aes(bus_stops, accidents), method = "lm",
              color = "red") + 
  geom_smooth(mapping=aes(transports, accidents), method = "lm", alpha = 0.2,
              se = TRUE, color = "cyan") +
  xlab(label = "transport and bus stops") + 
  ggtitle("Positive correlation between transport/bus stops and accidents") 
  theme_light()

p1

```
```{r echo=FALSE, results="hide", fig.keep="all", message=FALSE, running=FALSE}
p2 <- ggplot(df, aes(transports, bus_stops)) + geom_point() +
  geom_smooth(method = "lm") + 
  ggtitle("Positive correlation between transport and bus stops")
  theme_light()

p2
```

The two graphs above show that both the number bus stops and other transport stops in each neighborhood are positively associated with accidents and that also transports and bus stops are correlated themselves. It is possible that bus stops are a confounding variable in the correlation between transport stops and accidents. Thus, it is necessary to check the correlation again while keeping the number of bus stops constant

```{r echo=FALSE, results="hide", fig.keep="all"}

normalize = function(array){
  res <- sapply(array, function(x){
    (x-min(array))/(max(array)-min(array))
  })
}


# dat <- df[, bus_strata := with(df, cut(bus_stops, breaks = seq(0, 137, 15), labels = c("0-15", "15-30", 
#                                                                 "30-45", "45-60",
#                                                                 "60-75", "75-90",
#                                                                 "90-105", "105-120",
#                                                                 "120-135")))]

dat <- df[, bus_strata := with(df, cut(bus_stops, breaks = c(0, 30, 60, 90, 137), 
                                       labels = c("0-30","31-60","61-90", ">90")))]

#dat_normalized <- df[, c("bus_stops", "transports") := .(normalize(bus_stops),
#                                                         normalize(transports))]

dat %>%
  ggplot(aes(transports, accidents)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "lm") + 
  facet_wrap(~ bus_strata, scales = "free") + 
  ggtitle("Positive correlation accidents x transports",
          subtitle = "controlling for binned numbers of bus stops")
  theme_light()
  
```

In the above plot the number of bus stops are binned into 4 range categories. The correlation between accidents and transport stations seemingly persists even when conditioning for bus stops. However, in the last category only few datapoints remain and the resulting correlation is visibly influenced by the outlier having about 60 transport station. 

Below is the result for the spearman correlation test between :

- accidents and transport, controlling for bus stops  
- accidents and bus stops, controlling for transport stops. 

```{r echo=FALSE, fig.keep="all", message=FALSE, running=FALSE}
res1 <- pcor.test(df$accidents, df$transports, df$bus_stops, method = "spearman")
res2 <- pcor.test(df$accidents, df$bus_stops, df$transports, method = "spearman")

cor_dt <- data.table(test = c("accidents vs. transports",
                    "accidents vs. bus_stops"))
cor_dt <- cbind(cor_dt, rbind(res1, res2))
cor_dt
```


A positive correlation between accidents and transport stops of about 0.65 still remains and is statistically significant, even when controlling for bus stops. 

### Predicting the number of accidents given transport and bus stops. 
We can see that accidents are associated with transport opportunities and bus stops. This means that they could be used to create a model that helps predicting the average number of accidents given the number of bus and other transport stops. A good model could be useful for urban planners to anticipate the increase of accidents after installing different types of transport stations in a neighborhood. 

```{r echo=FALSE, results="hide", fig.keep="all", message=FALSE, running=FALSE, warning=FALSE}
set.seed(727)
training <- data.table(sample_n(dat, 0.8*nrow(dat)))
test <- anti_join(dat, training)
result_lm <- lm(accidents ~ bus_stops + transports, data = training)

test[, prediction := predict(result_lm, test)]
test[, residuals := accidents - prediction]
```

```{r echo=FALSE, results="hide", fig.keep="all", message=FALSE, running=FALSE, warning=FALSE}
test %>% 
  ggplot(aes(accidents, prediction)) + 
  geom_point() + stat_smooth(method="lm") + 
  ggtitle("Positive correlation between predicted number of accidents and actual number of accidents")
  theme_light()
```

```{r}
result_lm$coefficients
#print(summary(result_lm))
```
The results of the linear model suggest some predictive value of the variables bus stops and transport stops. However, one needs to be careful in drawing conclusions about the causality regarding the correlation between the number of different kinds of transport station and the number of accidents. The results of the model do not show that increasing the number of transport or bus stops causes an increase in accidents. ´

#########

### Logistic Regression 

Next we will analyse the distribution of the accidents throughout the day and the week.

```{r acc_hourly, fig.show="hold", out.width="50%"}
ggplot(acc_dt, aes(x=Hour)) + geom_bar() +labs(y="Number of accidents", title="Number of accidents by Hour")

acc_dt %>%
  mutate(Weekday=factor(Weekday, levels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) %>%
  ggplot(aes(x=Weekday)) + geom_bar() +
  labs(title="Number of accidents by Weekday") +
  theme(axis.title.y = element_blank())
```

As we can see, there are three peaks in the number of accidents: around 8-9 o'clock, 13-14 o'clock, and 18-19 o'clock. This leads us to believe that the traffic is expecially high at those times, which seems logical since these hours correspond to the _going-to-work-time_, _lunch-time_ and _coming-back-from-work-time_.´
This theory is further reinforced by the fewer of accidents during the weekend, days that people tend to spend at home.

For further visualization let's show the accident density first in general, and then facetted by the part of the day (Morning: 6-13 o'clock, Afternoon: 14-21 o'clock, Night: 22-5 o'clock) and weekdays.
```{r}
d1 <- ggplot(acc_dt, aes(Longitude, Latitude)) + 
    geom_density2d_filled()

d2 <- ggplot(acc_dt, aes(Longitude, Latitude)) + 
    geom_density2d_filled() + facet_wrap(~Part.of.the.day)

d1
d2
```
What is interesting here, is that the density focuses into one central point, namely the Eixample disctrict (calculated from the Long and Lat variables).
Looking at the plot facetted by part of the day, we can clearly see that accidents in areas leading from/to the center get more dense during the morning and afternoon. This further proves our theory from above.


To better understand the nature of the accidents, a prediction task was made using logistic regression. In this prediction, part of the day of the accident (which was categorized as morning and non-morning, includes "afternoon" and "night") was tried to guessed using features the features "district name", "weekday", "month", "mild injuries", "serious injuries", "victims", "vehicles involved". After the model was built, the confusion matrix and the accuracy of the model was computed and printed to show the performance our prediction.

```{r log_reg, include=FALSE, warning = FALSE}



# Create the input data frame.
data_dt_1 <- acc_dt[c(1:10339),c(2,5,6,7,8,9,10,11,12,13)] # starting from the 1st data point to all the end. 

# trying to guess: part of the days morning, not-morning (afternoon, night)
# features: district name, weekday, month, mild injuries, serious injuries, victims, vehicles involved 

# Encoding categorical data columns.
data_dt_1$District.Name = factor(data_dt_1$District.Name, level = c("Sant MartÃ­", "Ciutat Vella", "Eixample", "Sants-MontjuÃ¯c",  "Les Corts",  "SarriÃ -Sant Gervasi", "GrÃ cia",
                                                                   "Horta-GuinardÃ³","Nou Barris", "Sant Andreu"), labels = c(1,2,3,4,5,6,7,8,9,10))
data_dt_1$Weekday = factor(data_dt_1$Weekday, level = c("Friday", "Thursday", "Wednesday", "Saturday", "Tuesday", "Monday","Sunday"), labels = c(5,4,3,6,2,1,7))
data_dt_1$Month = factor(data_dt_1$Month, level = c("October","September", "December", "July", "May", "June","January", "April", "March", "November", "February", "August" ),
                         labels = c(10,9,12,7,5,6,1,4,3,11,2,8))
data_dt_1$Part.of.the.day = factor(data_dt_1$Part.of.the.day, level = c( "Morning", "Afternoon", "Night"), labels = c(0,1,1))



# shuffling the data

shuffle_index <- sample(1:nrow(data_dt_1))
data_dt_2 <- data_dt_1[shuffle_index, ] 


# split as train-test data
create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {c
    return (data[-train_sample, ])
  }
}


data_train <- create_train_test(data_dt_2, 0.8, train = TRUE)
data_test <- create_train_test(data_dt_2, 0.8, train = FALSE)

# Building our multiple logistic regression model

multi_logistic_model <- glm(Part.of.the.day ~ District.Name + Weekday + Month + Day + Hour + Mild.injuries + Serious.injuries + Victims + Vehicles.involved, data = data_train, family = "binomial")
multi_logistic_model
# summary(multi_logistic_model)

# Doing prediction
predict_reg <- predict(multi_logistic_model, data_test, type = "response")
 

# Hard classification
predict_reg <- ifelse(predict_reg >0.5, 1, 0)

# Evaluating model accuracy using confusion matrix
confusion_matrix = table(data_test$Part.of.the.day, predict_reg)

print(confusion_matrix)

# Calculating accuracy
missing_classerr <- mean(predict_reg != data_test$Part.of.the.day)
print(paste('Accuracy =', 1 - missing_classerr))

```

# Conclusions

TODO:

One crucial conclusion derived from the data is that where people move to is as important (or more) as to where they live. 
In increasingly expanding cities, people start to move to the outskirts (due to different factors like house pricing),  traveling daily to the center to work. Although we can't be sure this is the reason for the number of accidents in Eixample, we can notice looking at the map that this is indeed the most touristic and central district of Barcelona.

TODO: maybe image of the map

